<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <!--<link rel="stylesheet" type="text/css" href="/css/myPage/myPage.css">-->
    <link rel="stylesheet" type="text/css" href="/css/ticket/homepage_frame.css"/>
    <link rel="stylesheet" type="text/css" href="/css/ticket/homepage_content.css"/>
    <meta name="viewport" content="user-scalable=yes, initial-scale=1">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script type="text/javascript">
        $(function(){
            // custid 받아오기
            var custid = sessionStorage.getItem("custid");

            if(custid != null){
                $("#login").css('display', 'none');
                $("#regist").css('display', 'none');
                $("#logout").css('display','inline-block');
                $("#mypage").css('display','inline-block');
            }

            $("#logout").click(function(e){
                if(confirm("로그아웃 하시겠습니까?")){
                    $("#login").css('display', 'inline-block');
                    $("#regist").css('display', 'inline-block');
                    $("#logout").css('display','none');
                    $("#mypage").css('display','none');
                    sessionStorage.removeItem("custid");
                    e.preventDefault();
                }
            })

            /*$("#addBtn").click(function(){
                var arr = ($("#myform").serializeArray());
                var score = arr[0].value;						//별점 스코어 변환
                var review_content = $("#content").val();		//리뷰 내용

                console.log(score,review_content)

                var custid = "ym1234";
                var ticketid = 28;
                var reviewid = 3;

                var data = {
                    reviewid:reviewid,
                    custid:custid,
                    ticketid:ticketid,
                    score:score,
                    review_content:review_content
                }
                $.ajax({
                    url:"InsertReview",
                    data:data,
                    success:function(data){
                        if(data==1){
                            alert("리뷰등록완료")
                        }else{
                            alert("리뷰등록실패")
                        }
                    }
                })


            })*/



            // 예매내역 출력
            $.ajax({
                url:"BookByCustid",
                data:{custid:custid},
                success:function(arr){
                    //체크박스 해제위해 변수 하나 지정
                    var number = 0;

                    for(var i =0; i<arr.length; i++){
                        var div = $("<div></div>").addClass("booklist");
                        var a = $("<a></a>").attr({
                            ticketid: arr[i].ticketid,
                            id: "preview"+i,
                            href:"/detail?ticketid="+arr[i].ticketid
                        });
                        var img = $("<img>").attr({
                            src: "/images/"+arr[i].img_fname,
                            width : 200,
                            height: 251,
                        });
                        var title = $("<li></li>").html("제목 :"+arr[i].ticket_name);
                        var ul = $("<ul></ul>");
                        var bookid = $("<li></li>").html("예매번호 :"+arr[i].bookid);
                        var ticket_date = $("<li></li>").html("관람일 :"+arr[i].ticket_date);
                        var loc = $("<li></li>").html("상영관 :"+arr[i].loc);
                        var seatname = $("<li></li>").html("관람좌석 :"+arr[i].seatname);
                        var seatid = arr[i].seatid
                        // 오늘 날짜, 공연 날짜
                        var close = new Date(arr[i].ticket_date);
                        var today = new Date();
                        console.log("close:"+close);
                        console.log("today:"+today);

                        var button = $("<button>후기작성</button>").attr({
                            type:"button",
                            id : "btn_toReview"+i,
                            custid:custid,
                            ticketid: arr[i].ticketid
                        })

                        var checkbox = $("<input>").attr({
                            type:"checkbox",
                            id:"check2_"+i,
                            bookid:arr[i].bookid
                        })
                        var label = $("<label></label>").attr("for", "check2_"+i);

                        $(ul).append(bookid,title,ticket_date, loc, seatname);
                        $(a).append(img);
                        if(close < today) {
                            $(div).append(a, ul, button, label);
                        }else {
                            $(div).append(a, ul, checkbox, label);
                        }
                        $("#book_all").append(div);

                        // 이미지 클릭하면 detail 페이지로

                        var preview_id = '#preview'+i;

                        $(document).on('click', preview_id, function(e){
                            var target = this.id;
                            var ticketid = $("#"+target).attr("ticketid");
                            sessionStorage.setItem("ticketid", '');
                            sessionStorage.setItem("ticketid", ticketid);
                        });



                        // 후기작성 버튼 누르면 myPageReview로
                        var btn_toReview = '#btn_toReview'+i;

                        $(document).on('click', btn_toReview, function(e){
                            var target = this.id;
                            console.log("리뷰작성하기의 타겟:"+target);
                            var custid_btn = $("#"+target).attr("custid");
                            var ticketid = $("#"+target).attr("ticketid");

                            sessionStorage.setItem("custid", '');
                            sessionStorage.setItem("custid", custid_btn);
                            sessionStorage.setItem("ticketid", '');
                            sessionStorage.setItem("ticketid", ticketid);

                            $.ajax({
                                url:"/CheckReview",
                                data:{ticketid:ticketid, custid:custid},
                                success:function (re){
                                    if(re==0){
                                        var url = "/myPage/insertReview/"+ticketid;
                                        location.replace(url);
                                    }else{
                                        alert("이미 리뷰를 등록했습니다.")
                                    }
                                }
                            })

                        });

                        // 예매내역 삭제
                        var checkbox_delete = "#check2_"+i;

                        // delete_book함수는 bookid를 매개변수로 받아서 예매 취소 버튼을 누르면 예매취소 시키는 함수
                        var delete_book = function(bookid_delete) { // 예매내역 삭제 버튼 이벤트
                            $(document).on('click', '#book_cancel', function () {
                                var thisSeaid = this.seatid;
                                console.log("이게뭐지:" + bookid_delete);
                                console.log("누르면thisSeaid:" + thisSeaid);
                                $.ajax({
                                    url: "DeleteBook",
                                    data: {bookid: bookid_delete},
                                    success: function (del) {
                                        console.log("DeleteBook성공:"+del);
                                        if (del > 0) {
                                            console.log("DeleteBook에서 seatid:"+thisSeaid);
                                            $.ajax({
                                                url: "CancleSeat",
                                                data: {seatid: thisSeaid},
                                                success: function (cancle) {
                                                    if (cancle > 0) {
                                                        alert("삭제완료");
                                                    }
                                                }
                                            });
                                        }
                                    }
                                });
                            });
                        }

                        $(document).on('click', checkbox_delete, function(){ // 체크박스 체크하면 bookid 가져옴
                            number +=1;
                            var target = this.id;
                            console.log("체크박스 누르면타겟은:"+target);
                            console.log("체크박스 누르면:"+number);
                            var bookid_delete = $("#"+target).attr("bookid");
                            console.log(bookid_delete);
                            if(number % 2 == 1){
                                $("#"+target).attr('checked', true);
                                var bookid_delete = $("#"+target).attr("bookid");
                                delete_book(bookid_delete);
                            }else {
                                $("#"+target).attr('checked', false);
                                var bookid_delete = $("#"+target).removeAttr("bookid");
                            }
                        });
                    }
                }
            });

            // 네비게이션 바에서 클릭하면 카테고리별 목록으로 넘어가도록
            var time = 1;

            var cate_current = "";
            var cate_future = "";
            var cate_past = "";

            for (var i = 1; i <=4; i++) {
                cate_current = '#cate'+i+"_current";
                cate_future = '#cate'+i+"_future";
                cate_past = '#cate'+i+"_past";

                $(cate_current).click(function(e){
                    var target = this.id;
                    var cateid_num = $("#"+target).attr("cateid");
                    var time_num = $("#"+target).attr("time");

                    time = time_num;
                    cateid = cateid_num;
                    console.log(cateid);

                    sessionStorage.setItem("time", time);
                    sessionStorage.setItem("cateid", cateid);

                    var url = "/category?time="+time+"?cateid="+cateid;
                    location.replace(url);
                });

                $(cate_future).click(function(e){
                    var target = this.id;
                    var cateid_num = $("#"+target).attr("cateid");
                    var time_num = $("#"+target).attr("time");

                    time = time_num;
                    cateid = cateid_num;
                    console.log(cateid);

                    sessionStorage.setItem("time", time);
                    sessionStorage.setItem("cateid", cateid);

                    var url = "/category?time="+time+"?cateid="+cateid;
                    location.replace(url);
                });

                $(cate_past).click(function(e){
                    var target = this.id;
                    var cateid_num = $("#"+target).attr("cateid");
                    var time_num = $("#"+target).attr("time");

                    time = time_num;
                    cateid = cateid_num;
                    console.log(cateid);

                    sessionStorage.setItem("time", time);
                    sessionStorage.setItem("cateid", cateid);

                    var url = "/category?time="+time+"?cateid="+cateid;
                    location.replace(url);
                });
            }

            // 검색하면 결과가 나오도록
            var searchKeyword = function(f){
                $("#search_txt").keydown(function(e){ // 엔터 누르면 검색되도록 (아직 구현 X)
                    if(e.which == 13){
                        var keyword = $("#search_txt").val();
                        sessionStorage.setItem("keyword", keyword);
                        var url = "/search?keyword="+keyword;
                        location.replace(url);
                    }
                });

                $("#search_btn").click(function(){ // 버튼 누르면 검색됨
                    var keyword = $("#search_txt").val();
                    sessionStorage.setItem("keyword", keyword);
                    var url = "/search?keyword="+keyword;
                    location.replace(url);
                });
            }// 검색 end

            searchKeyword();
            $("#logout").click(function(){
                sessionStorage.removeItem("custid");
            });

        })

    </script>
</head>
<body class="main_layout">
<a href="/main"><img src="/images/icon/logo.png" id="logo"></a>
<div class="main_user">
    <a href="/login" id="login"><img src="/images/icon/loginicon.png">로그인</a>
    <a href="/main" id="logout"><img src="/images/icon/logouticon.png">로그아웃</a>
    <a href="/signUp" id="regist"><img src="/images/icon/signupicon.png">회원가입</a>
    <a href="/myPage" id="mypage"><img src="/images/icon/mypageicon.png">마이페이지</a>
</div>
<nav id="navigation">
    <div class="search" id="search" name="search">
        <input class="search_txt" type="search" placeholder="검색어 입력..." id="search_txt">
        <a class="search_btn" type="button" id="search_btn"><img  src="/images/icon/searchicon.png" width="35" height="35"></a>
    </div>
    <ul>
        <li class="home"><a href="/main">홈</a></li>
        <li><a href="#">시사회</a>
            <ul>
                <li><a id="cate1_current" cateid="1" time="1">현재상영작</a></li>
                <li><a id="cate1_future" cateid="1" time="2">개봉예정작</a></li>
                <li><a id="cate1_past" cateid="1" time="0">과거상영작</a></li>
            </ul>
        </li>
        <li><a href="#">뮤지컬</a>
            <ul>
                <li><a id="cate2_current" cateid="2" time="1">현재상영작</a></li>
                <li><a id="cate2_future" cateid="2" time="2">개봉예정작</a></li>
                <li><a id="cate2_past" cateid="2" time="0">과거상영작</a></li>
            </ul>
        </li>
        <li><a href="#">연극</a>
            <ul>
                <li><a id="cate3_current" cateid="3" time="1">현재상영작</a></li>
                <li><a id="cate3_future" cateid="3" time="2">개봉예정작</a></li>
                <li><a id="cate3_past" cateid="3" time="0">과거상영작</a></li>
            </ul>
        </li>
        <li><a href="#">콘서트</a>
            <ul>
                <li><a id="cate4_current" cateid="4" time="1">현재상영작</a></li>
                <li><a id="cate4_future" cateid="4" time="2">개봉예정작</a></li>
                <li><a id="cate4_past" cateid="4" time="0">과거상영작</a></li>
            </ul>
        </li>
    </ul>
</nav>
<div id="menu-bar">
    <ul>
        <li id="title">MyPage</li>
        <li><a href="/myPage">내 정보</a></li>
        <li id="mybook"><a href="/myPageBook">예매내역</a></li>
        <li><a href="/myPageDraw">드로우내역</a></li>
        <li><a href="/myPageReview">내 후기</a></li>
    </ul>
</div>
<div id="review_background">
<form action="/myPageBook">
    <div id="book_all"></div>
    <button id="book_cancel" type="submit">예매취소</button>
</form>
</div>
<div id="main-footer">
    <footer class="footer">
        <div>ⓒ CodingDoit corp.
        </div>
    </footer>
</div>
</body>
</html>